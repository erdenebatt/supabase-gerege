# Vector Log Collection Configuration
# Collects logs from Docker containers and sends to Logflare (analytics)

api:
  enabled: true
  address: 0.0.0.0:9001

sources:
  docker_host:
    type: docker_logs
    exclude_containers:
      - supabase-vector

transforms:
  project_logs:
    type: remap
    inputs:
      - docker_host
    source: |-
      .project = "default"
      .event_message = del(.message)
      .appname = del(.container_name)
      del(.container_created_at)
      del(.container_id)
      del(.source_type)
      del(.stream)
      del(.label)
      del(.image)
      del(.host)
      del(.timestamp)

  router:
    type: route
    inputs:
      - project_logs
    route:
      kong: '.appname == "supabase-kong"'
      auth: '.appname == "supabase-auth"'
      rest: '.appname == "supabase-rest"'
      realtime: '.appname == "supabase-realtime"'
      storage: '.appname == "supabase-storage"'
      db: '.appname == "supabase-db"'
      studio: '.appname == "supabase-studio"'

sinks:
  logflare_kong:
    type: "http"
    inputs:
      - "router.kong"
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_initial_backoff_secs: 1
    uri: "http://analytics:4000/api/logs?source_name=cloudflare.logs.prod&api_key=${LOGFLARE_API_KEY}"

  logflare_auth:
    type: "http"
    inputs:
      - "router.auth"
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_initial_backoff_secs: 1
    uri: "http://analytics:4000/api/logs?source_name=gotrue.logs.prod&api_key=${LOGFLARE_API_KEY}"

  logflare_rest:
    type: "http"
    inputs:
      - "router.rest"
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_initial_backoff_secs: 1
    uri: "http://analytics:4000/api/logs?source_name=postgREST.logs.prod&api_key=${LOGFLARE_API_KEY}"

  logflare_realtime:
    type: "http"
    inputs:
      - "router.realtime"
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_initial_backoff_secs: 1
    uri: "http://analytics:4000/api/logs?source_name=realtime.logs.prod&api_key=${LOGFLARE_API_KEY}"

  logflare_storage:
    type: "http"
    inputs:
      - "router.storage"
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_initial_backoff_secs: 1
    uri: "http://analytics:4000/api/logs?source_name=storage.logs.prod&api_key=${LOGFLARE_API_KEY}"

  logflare_db:
    type: "http"
    inputs:
      - "router.db"
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_initial_backoff_secs: 1
    uri: "http://analytics:4000/api/logs?source_name=postgres.logs&api_key=${LOGFLARE_API_KEY}"

  logflare_studio:
    type: "http"
    inputs:
      - "router.studio"
    encoding:
      codec: "json"
    method: "post"
    request:
      retry_initial_backoff_secs: 1
    uri: "http://analytics:4000/api/logs?source_name=studio.logs.prod&api_key=${LOGFLARE_API_KEY}"
